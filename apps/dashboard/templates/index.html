{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1>Wheel System Dashboard</h1>
    
    <!-- Best CSP Trade Card -->
    <section class="best-trade-section">
        <h2>Best CSP Trade (Latest Run)</h2>
        {% if best_csp_error %}
        <div class="error-message">
            <p>⚠️ Best CSP view not available. Please run migrations to create v_latest_run_best_csp_pick.</p>
        </div>
        {% elif not best_csp_pick %}
        <div class="info-message">
            <p>No best CSP trade found for latest run.</p>
        </div>
        {% else %}
        <div class="best-trade-card">
            {% set best_trade = best_trade_card.get("best_trade", {}) %}
            {% set why_this_trade = best_trade_card.get("why_this_trade", {}) %}
            {% set headline = best_trade.get("headline") or why_this_trade.get("headline") or "CSP " + (best_csp_pick.ticker or "N/A") + " $" + (best_csp_pick.strike|string or "0.00") + " " + (best_csp_pick.dte|string or "0") + "DTE" %}
            
            <div class="trade-headline">
                <h3>{{ headline }}</h3>
            </div>
            
            {% if why_this_trade.get("bullets") %}
            <div class="trade-bullets">
                <ul>
                    {% for bullet in why_this_trade.bullets[:6] %}
                    <li>{{ bullet }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            
            <div class="trade-stats">
                <table class="stats-table">
                    <tr>
                        <td><strong>Ticker:</strong></td>
                        <td>{{ best_csp_pick.ticker or "N/A" }}</td>
                        <td><strong>Expiration:</strong></td>
                        <td>{{ best_csp_pick.expiration or "N/A" }}</td>
                    </tr>
                    <tr>
                        <td><strong>DTE:</strong></td>
                        <td>{{ best_csp_pick.dte or "N/A" }}</td>
                        <td><strong>Strike:</strong></td>
                        <td>${{ "%.2f"|format(best_csp_pick.strike) if best_csp_pick.strike else "N/A" }}</td>
                    </tr>
                    <tr>
                        <td><strong>Premium:</strong></td>
                        <td>${{ "%.2f"|format(best_csp_pick.premium) if best_csp_pick.premium else "N/A" }}</td>
                        <td><strong>Delta:</strong></td>
                        <td>{{ "%.3f"|format(best_csp_pick.delta) if best_csp_pick.delta is not none else "N/A" }}</td>
                    </tr>
                    <tr>
                        <td><strong>Annualized Yield:</strong></td>
                        <td>{{ "%.2f"|format(best_csp_pick.annualized_yield * 100) if best_csp_pick.annualized_yield else "N/A" }}%</td>
                        <td><strong>Total Score:</strong></td>
                        <td>{{ "%.2f"|format(best_trade.total_score) if best_trade.get("total_score") is not none else (best_csp_pick.score|string if best_csp_pick.score is not none else "N/A") }}</td>
                    </tr>
                </table>
            </div>
            
            <div class="trade-actions">
                <a href="/picks?mode=all" class="btn">View all picks</a>
            </div>
        </div>
        {% endif %}
    </section>
    
    <!-- Summary Tiles -->
    <div class="summary-tiles">
        <div class="tile">
            <h3>Latest Run</h3>
            {% if runs and not runs_error %}
            <p class="tile-value">{{ runs[0].run_id[:8] if runs[0].run_id else "N/A" }}</p>
            <p class="tile-label">{{ runs[0].run_ts[:10] if runs[0].run_ts else "N/A" }}</p>
            {% else %}
            <p class="tile-value">N/A</p>
            {% endif %}
        </div>
        <div class="tile">
            <h3>Candidates</h3>
            <p class="tile-value">{{ candidates|length if candidates and not candidates_error else 0 }}</p>
            <p class="tile-label">Top 25</p>
        </div>
        <div class="tile">
            <h3>CSP Picks</h3>
            <p class="tile-value">{{ csp_picks|length if csp_picks and not csp_error else 0 }}</p>
            <p class="tile-label">Latest Run</p>
        </div>
        <div class="tile">
            <h3>CC Picks</h3>
            <p class="tile-value">{{ cc_picks|length if cc_picks and not cc_error else 0 }}</p>
            <p class="tile-label">Latest Run</p>
        </div>
    </div>
    
    <!-- Latest Candidates Table -->
    <section>
        <h2>Latest Top 25 Candidates</h2>
        {% if candidates_error %}
        <p>⚠️ View not found; run migrations to create v_latest_run_top25_candidates.</p>
        {% elif not candidates %}
        <p>No candidates found.</p>
        {% else %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Ticker</th>
                    <th>Score</th>
                    <th>Price</th>
                    <th>Market Cap</th>
                    <th>Sector</th>
                    <th>RSI</th>
                    <th>Earnings (days)</th>
                </tr>
            </thead>
            <tbody>
                {% for candidate in candidates %}
                <tr>
                    <td>{{ candidate.rank or "N/A" }}</td>
                    <td>{{ candidate.ticker or "N/A" }}</td>
                    <td>{{ "%.2f"|format(candidate.score) if candidate.score is not none else "N/A" }}</td>
                    <td>${{ "%.2f"|format(candidate.price) if candidate.price is not none else "N/A" }}</td>
                    <td>${{ "%.0f"|format(candidate.market_cap / 1000000) if candidate.market_cap else "N/A" }}M</td>
                    <td>{{ candidate.sector or "N/A" }}</td>
                    <td>{{ "%.1f"|format(candidate.rsi) if candidate.rsi is not none else "N/A" }}</td>
                    <td>{{ candidate.earn_in_days if candidate.earn_in_days is not none else "N/A" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </section>
    
    <!-- Latest CSP Picks Table -->
    <section>
        <h2>Latest CSP Picks (Top 5)</h2>
        {% if csp_error %}
        <p>⚠️ View not found; run migrations to create v_latest_run_csp_picks.</p>
        {% elif not csp_picks %}
        <p>No CSP picks found.</p>
        {% else %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>Ticker</th>
                    <th>Expiration</th>
                    <th>DTE</th>
                    <th>Strike</th>
                    <th>Premium</th>
                    <th>Delta</th>
                    <th>Yield</th>
                    <th>Score</th>
                </tr>
            </thead>
            <tbody>
                {% for pick in csp_picks %}
                <tr>
                    <td>{{ pick.ticker or "N/A" }}</td>
                    <td>{{ pick.expiration or "N/A" }}</td>
                    <td>{{ pick.dte or "N/A" }}</td>
                    <td>${{ "%.2f"|format(pick.strike) if pick.strike else "N/A" }}</td>
                    <td>${{ "%.2f"|format(pick.premium) if pick.premium else "N/A" }}</td>
                    <td>{{ "%.3f"|format(pick.delta) if pick.delta is not none else "N/A" }}</td>
                    <td>{{ "%.2f"|format(pick.annualized_yield * 100) if pick.annualized_yield else "N/A" }}%</td>
                    <td>{{ "%.2f"|format(pick.score) if pick.score is not none else "N/A" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <p><a href="/picks?mode=all">View all CSP picks</a></p>
        {% endif %}
    </section>
    
    <!-- Latest CC Picks Table -->
    <section>
        <h2>Latest CC Picks (Top 5)</h2>
        {% if cc_error %}
        <p>⚠️ View not found; run migrations to create v_latest_run_cc_picks.</p>
        {% elif not cc_picks %}
        <p>No CC picks found.</p>
        {% else %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>Ticker</th>
                    <th>Expiration</th>
                    <th>DTE</th>
                    <th>Strike</th>
                    <th>Premium</th>
                    <th>Delta</th>
                    <th>Yield</th>
                    <th>Score</th>
                </tr>
            </thead>
            <tbody>
                {% for pick in cc_picks %}
                <tr>
                    <td>{{ pick.ticker or "N/A" }}</td>
                    <td>{{ pick.expiration or "N/A" }}</td>
                    <td>{{ pick.dte or "N/A" }}</td>
                    <td>${{ "%.2f"|format(pick.strike) if pick.strike else "N/A" }}</td>
                    <td>${{ "%.2f"|format(pick.premium) if pick.premium else "N/A" }}</td>
                    <td>{{ "%.3f"|format(pick.delta) if pick.delta is not none else "N/A" }}</td>
                    <td>{{ "%.2f"|format(pick.annualized_yield * 100) if pick.annualized_yield else "N/A" }}%</td>
                    <td>{{ "%.2f"|format(pick.score) if pick.score is not none else "N/A" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </section>
</div>
{% endblock %}
